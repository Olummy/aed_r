---
title: 'AED R and Friends: `ggplot2` figures for your manuscript'
output:
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, echo=FALSE, warning=FALSE, purl=FALSE, message=FALSE}
library(knitr)
options(repos="http://cran.rstudio.com/")
pkgs <- c("dplyr","ggplot2","plotly")
x<-lapply(pkgs, library, character.only = TRUE)
opts_chunk$set(tidy=T, root.dir = "meetings")
```
 
# Making the figures
There are a gazillion different ways to visualize the same data.  For this short workshop we will use two datasets and create two separate plots, a bar chart with error bars and a depth profile plot.  From this we should learn how to create these plots with `ggplot2`, learn that datasets need to be manipulated for different visualizations, and learn how to save the plots to files for inclusion into a manuscript.  If there is time at the end we will show some examples of interactive figures and animations using `ggplot2`.

## Data for bar chart: NLA 2012
Assuming we still have access to it, we will use the NLA 2012 water quality data for the bar chart with error bars.  Specifically we will be interested in total nitrogen, total phosphorus, and ecoregion.  First, let's load up our packages:

```{r packages}
library(dplyr) # For some basic data massaging
library(tidyr) # Also for some basic data massaging
library(ggplot2) # For the plots
library(plotly) # For interacive plots with plotly
library(gganimate) # For animations. Not yet on CRAN, so need devtools
```

Next, to get the data:

```{r data}
nla12_wq_url <- "https://www.epa.gov/sites/production/files/2016-12/nla2012_waterchem_wide.csv"
nla12_site_url <- "https://www.epa.gov/sites/production/files/2016-12/nla2012_wide_siteinfo_08232016.csv"

# Read, join, filter, select data
nla12_wq <- read.csv(nla12_wq_url, stringsAsFactors = FALSE) 
nla12_site <- read.csv(nla12_site_url, stringsAsFactors = FALSE)
nla12 <- full_join(nla12_wq,nla12_site) %>%
  filter(VISIT_NO == 1) %>%
  select(SITE_ID, FW_ECO9, NTL_RESULT, PTL_RESULT) %>%
  na.omit()
tbl_df(nla12)  
```

So now we have total nutrients and a categorical representing the ecoregion for the data.  Let's start plotting this out.

## Bar chart with error bars

(These instructions inspired by the [R Graphics Cookbook](http://www.cookbook-r.com/Graphs/Plotting_means_and_error_bars_(ggplot2)/#bar-graphs))

Prior to jumping into coding any figure I like to think a bit about what I want to show and will actually sketch that out on paper.  Doing this also forces you to start thinking about what data you need to create that figure. In the case of the bar chart with error bars at a minimum we will need some mean value to plot and some representation of error for the error bars.  Another common thing to do is plot this for multiple categories and for multiple values.  

For this example, we will be interested in looking at Nitrogen and Phosphorus concentrations across ecoregions.  Thus we will need to summarize the per lake data on an ecoregional basis and get the mean and standard error for each nutrient within each ecoregion.   Also, many of the `ggplot2` functions will easily create seperate plots if a catergorical factor is supplied.  We will keep this in mind becuase we want different bars for each of the variables.

Given this we need a data frame that looks like:

|Ecoregion|Nutrient|Mean|Standard Error|
|---------|--------|----|--------------|


```{r barchart_data}
nla12_bar_mean <- nla12 %>%
  group_by(FW_ECO9) %>%
  summarize(nitrogen = mean(log1p(NTL_RESULT)),
            phosphorus = mean(log1p(PTL_RESULT))) %>%
  gather("variable", "mean", 2:3)

nla12_bar_se <- nla12 %>%
  group_by(FW_ECO9) %>%
  summarize(nitrogen = sd(log1p(NTL_RESULT))/sqrt(length(NTL_RESULT)),
            phosphorus = sd(log1p(PTL_RESULT))/sqrt(length(PTL_RESULT))) %>%
  gather("variable", "std_error", 2:3)

nla12_bar_data <- full_join(nla12_bar_mean, nla12_bar_se)
nla12_bar_data
```

Now that was easy!  I am being purposely glib, becuase the part that we just did is really about 90% of the effort.  In reality this usually takes me a couple of iterations of getting things wrong. Now we can use this to build out our plot.

```{r barchart}
nla12_bar <- ggplot(nla12_bar_data,aes(x = FW_ECO9, y = mean, fill = variable)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=mean-std_error, ymax=mean+std_error),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9))

nla12_bar
```

### Re-order x-axis

### Change colors of bars

### Move beyond the default theme

## Profile plot

# Saving the figures
Once you have the details of your figure, figured (he, he) out you need to move it from the screen and into your manuscript.  This requires saving the output to a file.  The `ggplot2` package comes with a function to facilitate this, `ggsave()`.  To output a ggplot2 object to a high resolution tiff:

```{r ggsave}
ggsave(filename = "nla_bar_chart.tiff",
       plot = nla12_bar,
       path = "meetings",
       width = 8,
       height = 4,
       units = "in", 
       dpi = 300)
```

This should get you pretty close to providing the figures required by the journal you are submitting too.  If there are additional things you need to do your figure you can either edit the file directly in an image processing program (e.g. gimp or irfanview) or you can manipulate the file in R with the `magick` package, essentially an R client for ImageMagick.  Using `magick` is a bit beyond the scope of what we want to do today, but I will show a quick example of something I had to do for a paper recently: remlibmagick++-devove white space around borders of the image.  We can do with this using the auto crop functionality in `magick`.

```{r autocrop}
library(magick)
nla_fig <- image_read("meetings/nla_bar_chart.tiff")
nla_fig <- image_trim(nla_fig)
image_write(nla_fig, "meetings/nla_bar_chart_trim.tiff" )
```

# Other stuff: interactive plots and animation